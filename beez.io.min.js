var BEEZIO_VERSION="0.1.0";"undefined"!=typeof module&&module.exports?exports.VERSION=BEEZIO_VERSION:!function(a){define(function(b){var c=b("beez"),d=c.vendor._,e=c.getLogger("beez.io"),f=function(a){return a=a.replace(/[\-{}\[\]+?.,\\\^$|#\s]/g,"\\$&").replace(/%.{1}/g,"(.+?)"),new RegExp("^"+a+"$")},g=function(){for(var a=Array.prototype.slice.call(arguments),b=a.pop(),c=0;c<a.length;c++)b=b.replace(/%.{1}/,a[c]);return b},h=function(a){function b(){this.url="",this.callbacks={},this.handler={},this.transportType=null,this.io=null,this.format="",this.regexp=""}return b.prototype.setup=function(b){b=b||{};var f=this;a.io||f.onError(new c.Error("io is not found.")),f.options=b,c.manager.m.io=this,b.namespace?b.namespace.indexOf("")<0&&b.namespace.unshift(""):b.namespace=[""],this.configure(b).open(b.namespace);var g=f.io.engine,h=g.onPacket;return this.io.engine.onPacket=function(){try{h.apply(g,arguments)}catch(a){e.error(a)}},d.each(b.namespace,function(a){f.io.of(a).on("connect",function(){if(e.debug("status connect to url:",f.url," namespace:","/"+a),""===a){var b=f.io.engine,c=b.onHeartbeat;f.io.engine.onHeartbeat=function(a){e.debug("Heartbeat!",a),c.apply(b,arguments),f.onHeartbeat(a)}}}),f.io.of(a).on("connecting",function(a){e.debug("connecting transport type:",a),f.transportType=a}),f.io.of(a).on("connect_failed",function(a){e.error("connect fail:",a),f.onError(a)}),f.io.of(a).on("close",function(a){e.debug("connection closed:",a),f.onClose(a)}),f.io.of(a).on("disconnect",function(a){e.error("disconnect:",a),f.onClose(a)}),f.io.of(a).on("reconnect",function(a,b){e.warn("reconnect:",a,",",b)}),f.io.of(a).on("reconnecting",function(a,b){e.warn("reconnecting:",a,",",b)}),f.io.of(a).on("reconnect_failed",function(a){e.error("reconnect failed:",a),f.onError(a)}),f.io.of(a).on("error",function(a){e.error("error reason:",a),f.onError(a)}),f.io.of(a).on("message",function(a){e.debug("get Sever respose:",a),f.invoke(a)})}),this},b.prototype.configure=function(a){return a.host&&(this.url+=a.host||location.host),a.port&&(this.url+=":"+a.port),this.format=a.format||"%s.%s:%s",this.regexp=f(this.format),this},b.prototype.open=function(b){var c=this;return c.io=a.io.Manager(this.url),d.each(b,function(a){c.io.socket("/"+a)}),c.io.of=function(a){return a="/"+a,c.io.nsps[a]},c},b.prototype.onError=c.none,b.prototype.onClose=c.none,b.prototype.onHeartbeat=c.none,b.prototype.join=function(a,b){e.debug("join room ",a,"namespace: ",b),b=b||"/",this.io.of(b).emit("join",a)},b.prototype.use=function(a){if(!a.name)throw new c.Error("handler name is not define");this.handler[a.name]&&e.warn("handler name ",a.name," is already exists"),this.handler[a.name]=a},b.prototype.invoke=function(a){var b,c,d=this.parse(a);return d.body&&(b=this.callbacks[d.body._req],b&&(delete this.callbacks[d.body._req],b(d))),d.service&&(c=this.handler[d.service]&&this.handler[d.service][d.method],c&&c.call(this.handler[d.service],d)),this},b.prototype.get=function(a){return this.io.of(a)},b.prototype.on=function(a,b,c){var d=c?this.io.of(c):this.io;d.on(a,b)},b.prototype.bindIo=function(a){var b=this,d={};if(!a.io)throw new c.Error("It is necessary to set io option to a model.");c.utils.isString(a.io)?(d.name=a.io,a.io=d):c.utils.isObject(a.io)&&(d=a.io),this.ready(function(c){var f=c.of(d.name);b.join(d.room,d.name),f.on("message",function(c){e.debug("get Server response. ",c);var d=b.parse(c),f=a.io.event||"io";d.method&&a.trigger(f+":"+d.method,d.body)})})},b.prototype.send=function(a,b){var f=this,h=a.namespace||"/",i=a.data||{},j=a.service,k=a.method;return this.ready(function(a){var l,m=a.of(h);c.utils.isFunction(b)&&(i._req=d.uniqueId(),f.callbacks[i._req]||(f.callbacks[i._req]=b));try{var l=g(j,k,JSON.stringify(i),f.format);e.debug("send",l),m.send(l)}catch(n){throw n}return f}),f},b.prototype.ready=function(a){var b=this;return b.io.connected?a&&a(b.io):(b.io.of("").on("connect",function(){a&&a(b.io)}),b)},b.prototype.parse=function(a){var b=a.match(this.regexp);if(!b)throw new c.Error("data format is illegal");var d=b[1],e=b[2],f=b[3];try{return f=JSON.parse(f),{body:f,service:d,method:e}}catch(g){throw new c.Error("parse error")}},d.each(["create","read","update","delete"],function(a){b.prototype[a]=function(b,c,d,e){this.send({service:b,method:a,namespace:d,data:c},e)}}),b}(a),i=c.vendor.Backbone.sync;return c.vendor.Backbone.sync=function(a,b,d){if(("delete"===a||"create"===a)&&b.isNew()&&b.collection&&b.collection.io&&(b=b.collection),!b.io||d.direct)i.apply(this,arguments);else{var e=d.success||c.none,f=d.service||b.io.name,g=d.data||{};c.manager.m.io[a](f,g,b.io.name,function(a){e(a.body)})}},new h})}(this);